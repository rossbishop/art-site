service: database-clear
frameworkVersion: '2'

provider:
  name: aws
  runtime: python3.8
  region: eu-west-2
  stage: dev
  iamRoleStatements:
    - Effect: 'Allow'
      Action:
        - 'dynamodb:*'
      Resource:
        - '*'

functions:
  createProject:
    handler: api/project.create
    memorySize: 128
    events:
      - http:
        path: project
        method: post
        request:
          schema:
            application/json: ${file(requestSchemas/createProject.json)}
          parameters:
            headers:
              Content-Type: true
              Authorization: true
        authorizer: 
          name: UserPoolAuthorizer
          type: COGNITO_USER_POOLS
          arn:
            Fn::GetAtt:
              - ArtShareUserPool
              - Arn

  readProject:
    handler: api/project.read
    memorySize: 128
    events:
      - http:
        path: project/{id}
        method: get
        request:
          parameters:
            headers:
              Content-Type: true
            paths:
              id: true

  updateProject:
    handler: api/project.update
    memorySize: 128
    events:
      - http:
        path: project/{id}
        method: put
        request:
          schema:
            application/json: ${file(requestSchemas/updateProject.json)}
          parameters:
            headers:
              Content-Type: true
              Authorization: true
            paths:
              id: true          
        authorizer: 
          name: UserPoolAuthorizer
          type: COGNITO_USER_POOLS
          arn:
            Fn::GetAtt:
              - ArtShareUserPool
              - Arn

  deleteProject:
    handler: api/project.delete
    memorySize: 128
    events:
      - http:
        path: project/{id}
        method: delete
        request:
          parameters:
            querystrings:
              accessToken: true
            headers:
              Content-Type: true
              Authorization: true
            paths:
              id: true        
        authorizer: 
          name: UserPoolAuthorizer
          type: COGNITO_USER_POOLS
          arn:
            Fn::GetAtt:
              - ArtShareUserPool
              - Arn        

resources:
  Resources:
    ArtShareProjectTable:
      Type: 'AWS::DynamoDB::Table'
      Properties:
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        KeySchema: 
          - AttributeName: id
            AttributeType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        TableName: ArtShareProjectTable
    ArtShareUserPool:
      Type: 'AWS::Cognito::UserPool'
      Properties:
        MfaConfiguration: OFF
        UserPoolName: ArtShareUserPool
        UsernameAttributes:
          - email
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: false
            RequireUppercase: false
    ArtShareUserPoolResourceServer:
      Type: 'AWS::Cognito::UserPoolResourceServer'
      Properties:
        Identifier: artshare-api
        Name: artshare-api
        Scopes:
          - createProject: Create an existing project
          - updateProject: Update an existing project
          - deleteProject: Delete an existing project  
        UserPoolId:
          Ref: ArtShareUserPool         
    ArtShareUserPoolClient:
      Type: 'AWS::Cognito::UserPoolClient'
      Properties:
        ClientName: ArtShareUserPoolClient
        GenerateSecret: true
        UserPoolId:
          Ref: ArtShareUserPool
        AllowedOAuthFlows:
          - code
        AllowedOAuthFlowsUserPoolClient: true
        AllowedOAuthScopes:
          - email
          - openid
          - profile
          - artshare-api/createProject  
          - artshare-api/updateProject
          - artshare-api/deleteProjet
    ArtShareUserPoolDomain:
      Type:
      Properties:
        Domain: artsharetestserverless.auth.eu-west-2.amazoncognito.com
      UserPoolId:
        Ref: ArtShareUserPool 


